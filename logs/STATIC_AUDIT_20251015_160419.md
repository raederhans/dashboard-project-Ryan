# Static Repository Audit — 2025-10-15 16:04

**Scope:** Read-only structural analysis, no execution, no source edits

---

## A. Top-Level Inventory

### Vite Structure Verdict

| Item | Expected | Actual | Status |
|------|----------|--------|--------|
| `/index.html` (root entry) | ✅ Required | ❌ **MISSING** | 🔴 **BLOCKER** |
| `/public/index.html` | ❌ Should NOT exist | ✅ EXISTS (7.6K) | 🔴 **BLOCKER** |
| `/vite.config.js` | ⚠️ Optional | ✅ EXISTS with `root: 'public'` | 🔴 **BLOCKER** |
| `/public/` (static assets only) | ✅ Yes | ⚠️ Contains HTML entry | 🔴 **BLOCKER** |
| `/src/` (app modules) | ✅ Yes | ✅ 34 .js files | ✅ OK |
| `/package.json` | ✅ Required | ✅ EXISTS | ✅ OK |

**Critical Issue:** Vite project structure is **VIOLATED**. The `vite.config.js` sets `root: 'public'` and HTML entry is in `/public/index.html` instead of project root. This causes build failures (HTML inline proxy errors).

---

## B. Directory Trees & Sizes

### /public (Static Assets)
```
public/
├── data/
│   └── police_districts.geojson    364K    (districts boundary GeoJSON)
└── index.html                      7.6K    (🔴 WRONG LOCATION - should be at root)
```

### /src (Application Modules) - 34 files
```
src/
├── api/                4 files    (crime.js, boundaries.js, acs.js, index.js)
├── charts/             4 files    (index.js, line_monthly.js, bar_topn.js, heat_7x24.js)
├── compare/            1 file     (card.js)
├── config.js           1 file
├── main.js             1 file     (entry orchestration)
├── map/               14 files    (init, districts, tracts, points, buffer, popups, tooltips, etc.)
├── state/              2 files    (store.js, index.js)
├── ui/                 1 file     (panel.js)
└── utils/              6 files    (sql.js, http.js, types.js, geoids.js, district_names.js, join.js, pop_buffer.js)
```

### /src/data (Data Artifacts) - 3 files
```
src/data/
├── offense_groups.json             455 bytes   (Object<string, string[]> - ✅ VALID)
├── acs_tracts_2023_pa101.json       45K        (Array[381] tract objects)
└── README.md                       (docs)
```

### /scripts - 10 files
```
scripts/
├── audit_offense_codes.mjs
├── fetch_acs_tracts.mjs
├── fetch_districts.js
├── fetch_tracts.mjs
├── fix_offense_groups.mjs
├── precompute_tract_counts.mjs
├── validate_offense_groups.mjs
├── codex_loop.ps1
├── monitor_todo.ps1
└── watchdog_rules.md
```

### /docs - 8+ markdown files
```
docs/
├── CHANGELOG.md
├── CONTROL_SPEC.md
├── DEPLOY.md
├── FIX_PLAN.md
├── KNOWN_ISSUES.md
├── TODO.md
└── (more from this session)
```

---

## C. Data Artifacts Validation

### 1. offense_groups.json ✅ VALID
**Path:** `src/data/offense_groups.json` (455 bytes)

**Structure:** `Object<string, string[]>`

**Content (validated 2025-10-15 16:04):**
```json
{
  "Assault_Gun": ["Aggravated Assault Firearm", "Aggravated Assault No Firearm"],
  "Burglary": ["Burglary Non-Residential", "Burglary Residential"],
  "Property": ["Thefts"],
  "Robbery_Gun": ["Robbery Firearm", "Robbery No Firearm"],
  "Vandalism_Other": ["Narcotic / Drug Law Violations", "Vandalism/Criminal Mischief"],
  "Vehicle": ["Motor Vehicle Theft", "Theft from Vehicle"]
}
```

**Status:** ✅ All values are arrays. Previously had `"Property": "Thefts"` (string) but was fixed.

---

### 2. acs_tracts_2023_pa101.json ✅ VALID
**Path:** `src/data/acs_tracts_2023_pa101.json` (45K)

**Structure:** Array of 381 tract objects

**Fields per object:**
- `geoid` (string, 11 chars, format: `42101XXXXXX`)
- `pop` (number, population)
- `hh_total` (number, total households)
- `renter_total` (number, renter households)
- `median_income` (number, -666666666 = N/A)
- `poverty_pct` (number, percentage)

**Status:** ✅ Valid JSON array. Covers Philadelphia County (FIPS 42101).

**Note:** 4 tracts have `median_income: -666666666` (sentinel for missing data):
- 42101014800
- 42101016500
- 42101020500
- 42101027700

---

### 3. police_districts.geojson (assumed valid)
**Path:** `public/data/police_districts.geojson` (364K)

**Status:** Not inspected in detail (binary-ish, large). Assumed to be FeatureCollection with ~22-24 district polygons.

---

### 4. tracts_phl.geojson ❌ NOT FOUND
**Expected:** `public/data/tracts_phl.geojson` OR cached endpoint

**Status:** File not present in `public/data/`. Code in `src/map/tracts_view.js` likely fetches from remote URLs with fallback.

---

### 5. tract_counts_last12m.json ❌ NOT FOUND
**Expected:** `src/data/tract_counts_last12m.json`

**Status:** Not present. Script exists to generate it (`scripts/precompute_tract_counts.mjs`) but artifact not committed.

---

## D. Config Files

### vite.config.js 🔴 PROBLEMATIC
```javascript
import { defineConfig } from 'vite';

export default defineConfig({
  root: 'public',           // 🔴 WRONG - causes HTML proxy errors
  build: {
    outDir: '../dist',      // relative path due to root: 'public'
    emptyOutDir: true,
  },
  server: {
    port: 5173,
    fs: { strict: false, allow: ['..'] },  // fs.allow needed due to wrong root
  },
  preview: {
    port: 4173,
  },
});
```

**Issues:**
1. `root: 'public'` violates Vite convention (`index.html` must be at project root)
2. `outDir: '../dist'` is relative (should be `'dist'` with proper root)
3. `fs.allow: ['..']` is a band-aid for accessing `src/` from `public/` root

**Fix:** Remove `root: 'public'`, change `outDir: 'dist'`, remove `fs.allow`, move `public/index.html` → `index.html`.

---

### public/index.html (partial inspection)
**Size:** 7735 bytes (131 lines approx)

**Key elements (from prior reads):**
- Line 129: `<script type="module" src="../src/main.js"></script>` 🔴 WRONG (relative path going up)
- Should be: `<script type="module" src="/src/main.js"></script>` (absolute from root)

---

## E. Grep Patterns & Key Code Locations

### SQL SRID Usage (src/utils/sql.js)
```javascript
// Envelope for bbox filters
`AND the_geom && ST_MakeEnvelope(${xmin}, ${ymin}, ${xmax}, ${ymax}, 3857)`

// Buffer for point proximity
`AND ST_DWithin(the_geom, ST_SetSRID(ST_Point(${x}, ${y}), 3857), ${distance})`

// Geometry column
"SELECT the_geom, dispatch_date_time, text_general_code, ucr_general, dc_dist, location_block"
```

**Observations:**
- Uses `the_geom` (Web Mercator EPSG:3857) consistently
- Envelope and buffer both use SRID 3857
- ✅ No SRID mismatch detected

---

### Clustering (src/map/points.js)
```javascript
const clusterId = 'clusters';
const clusterCountId = 'cluster-count';
const unclusteredId = 'unclustered';

// Clustering config
{
  cluster: true,
  clusterMaxZoom: 14,
  clusterRadius: 40,
}
```

**Guards:** Check for >20k feature limit (not found in points.js grep - may be in higher-level logic)

---

### Cache TTLs (src/utils/http.js - not grepped, assumed present)
Expected patterns:
- `sessionTTL`, `memoryTTL`
- Retry/backoff logic
- In-flight deduplication

---

### Import/Export Check
**Not performed exhaustively.** Full dependency graph audit would require:
```bash
grep -rh "^export " src/ | sort
grep -rh "^import " src/ | grep -v "node_modules" | sort
```
Cross-reference to find orphaned exports.

---

## F. Subsystem File Listing

### 1. Controls & State (5 files)
- `public/index.html` (control IDs: addrA, useCenterBtn, radiusSel, twSel, groupSel, fineSel, adminSel, rateSel, startMonth, durationSel, preset6, preset12)
- `src/ui/panel.js` (DOM listeners, debounce, event → store)
- `src/state/store.js` (state keys: selectMode, centerLonLat, center3857, radius, startMonth, durationMonths, timeWindowMonths, adminLevel, per10k, selectedGroups, selectedTypes)
- `src/state/index.js` (export)

### 2. Maps (14 files in src/map/)
- `initMap.js` — MapLibre init, OSM raster style
- `choropleth_districts.js` — fetch + merge districts GeoJSON with crime counts
- `render_choropleth.js` — district fill layer + breaks/colors + labels + hover
- `tracts_view.js` — fetch tracts GeoJSON (multi-endpoint fallback)
- `render_choropleth_tracts.js` — tract fill layer + per-10k logic
- `points.js` — fetch crime points, cluster config, unclustered colors
- `wire_points.js` — (assumed) wiring for point refresh
- `buffer_overlay.js` — Turf circle for buffer A
- `ui_tooltip.js` — hover tooltip for choropleth
- `ui_popup_district.js` — click popup on districts
- `ui_legend.js` — draw legend (breaks + colors)
- `style_helpers.js` — quantile breaks calculator
- `index.js` — exports

### 3. Charts (4 files in src/charts/)
- `index.js` — `updateAllCharts(filters)`
- `line_monthly.js` — monthly time series (Chart.js line)
- `bar_topn.js` — top-N offense types (Chart.js bar)
- `heat_7x24.js` — hour × day heatmap (Chart.js matrix)

### 4. API & SQL (7 files)
- `src/api/crime.js` — fetch helpers (points, by district, by tract, top-N, 7x24, monthly)
- `src/api/boundaries.js` — fetch districts/tracts GeoJSON
- `src/api/acs.js` — fetch ACS data (if not using local JSON)
- `src/api/index.js` — exports
- `src/utils/sql.js` — SQL builders (envelope, within, buffer, aggregations, filters)
- `src/utils/http.js` — fetch wrapper (cache, dedupe, retry)

### 5. Types & Mappings (4 files in src/utils/)
- `types.js` — `expandGroupsToCodes()`, `groupColor()`, `categoryColorPairs()`
- `geoids.js` — tract GEOID helpers
- `district_names.js` — district code → name map
- `join.js` — join helpers for GeoJSON

### 6. Entry & Orchestration (1 file)
- `src/main.js` — DOMContentLoaded → initMap → choropleth → points → charts → panel wiring → onChange fan-out

---

## G. Structural Risks & Smells

| # | Severity | Symptom | Evidence | Minimal Fix |
|---|----------|---------|----------|-------------|
| 1 | 🔴 BLOCKER | Vite root set to `public/` | `vite.config.js:4` `root: 'public'` | Remove line 4, change line 6 `outDir: 'dist'`, delete line 11 `fs.allow` |
| 2 | 🔴 BLOCKER | HTML entry in wrong location | `/index.html` missing, `public/index.html` exists | Move `public/index.html` → `index.html` |
| 3 | 🔴 BLOCKER | Script tag uses relative path | `public/index.html:129` `src="../src/main.js"` | Change to `src="/src/main.js"` |
| 4 | ⚠️ HIGH | Missing tract GeoJSON cache | `public/data/tracts_phl.geojson` not found | Run `scripts/fetch_tracts.mjs` or accept remote fallback |
| 5 | ⚠️ MEDIUM | Missing precomputed tract counts | `src/data/tract_counts_last12m.json` not found | Run `scripts/precompute_tract_counts.mjs` or accept live aggregation |
| 6 | 🟡 LOW | ACS median_income sentinel value | 4 tracts have `-666666666` | Filter or replace with `null` in rendering logic |

---

## H. Import/Export Orphans (Not Exhaustively Checked)

**Manual spot checks recommended:**
- `src/config.js` — What does it export? Is it used?
- `src/utils/pop_buffer.js` — Is this imported anywhere?
- `src/map/wire_points.js` vs `src/map/points.js` — Which is the active module?

---

## I. JSON/GeoJSON Validity Summary

| File | Type | Status | Notes |
|------|------|--------|-------|
| `src/data/offense_groups.json` | Object<string, string[]> | ✅ VALID | All values are arrays |
| `src/data/acs_tracts_2023_pa101.json` | Array[381] | ✅ VALID | 4 tracts have sentinel `-666666666` for median_income |
| `public/data/police_districts.geojson` | FeatureCollection (assumed) | ⚠️ NOT INSPECTED | 364K file |
| `public/data/tracts_phl.geojson` | FeatureCollection (expected) | ❌ NOT FOUND | Fetched remotely |
| `src/data/tract_counts_last12m.json` | Object {rows, meta} (expected) | ❌ NOT FOUND | Run precompute script |

---

## J. Key Functions & Call Paths (Abbreviated)

### Control → Refresh Flow
```
User changes control (e.g., radiusSel)
  → panel.js addEventListener('change', ...)
  → store.radius = Number(value)
  → debounce(onChange, 300ms)
  → refreshAll() in main.js
    → getDistrictsMerged({ start, end, types })
    → renderDistrictChoropleth(map, merged)
    → refreshPoints(map, { start, end, types })
    → updateAllCharts({ start, end, types, center3857, radiusM })
    → updateCompare({ types, center3857, radiusM, ... })
```

### SQL Query Flow
```
src/api/crime.js: fetchByDistrict({ start, end, types })
  → src/utils/sql.js: buildDistrictQuery({ start, end, types })
    → envelope filter: ST_MakeEnvelope(..., 3857)
    → type filter: text_general_code IN ('X', 'Y')
    → date filter: dispatch_date_time >= start AND < end
  → src/utils/http.js: cachedFetch(url, { ttl, key })
    → in-flight dedupe + session/memory cache
```

### Map Initialization
```
src/main.js: DOMContentLoaded
  → src/map/initMap.js: initMap()
    → new maplibregl.Map({ style: { version: 8, sources: { osm: raster } } })
  → src/map/choropleth_districts.js: getDistrictsMerged()
  → src/map/render_choropleth.js: renderDistrictChoropleth(map, merged)
    → quantileBreaks(values, 5)
    → map.addLayer('districts-fill', 'districts-line', 'districts-label')
  → src/map/ui_tooltip.js: attachHover(map, 'districts-fill')
  → src/map/ui_popup_district.js: attachDistrictPopup(map, 'districts-fill')
```

---

## K. Quick Grep Results

### TODO/Placeholder Checks
```bash
grep -ri "TODO\|placeholder\|not implemented" src/ --include="*.js" | wc -l
# (Not run in this audit - recommend manual check)
```

### Error Handling
```bash
grep -rn "throw new Error\|console.error\|console.warn" src/ --include="*.js" | head -10
# (Not run - recommend checking error boundaries in main.js, initMap.js)
```

### MapLibre CSS Link
```bash
grep -n "maplibre-gl.css" public/index.html
# Expected: <link href="https://unpkg.com/maplibre-gl@^4.5.0/dist/maplibre-gl.css" rel="stylesheet" />
```

### Cluster Threshold (20k guard)
```bash
grep -rn "20000\|20_000\|features.length" src/map/points.js
# (Not found in initial grep - may be in different file or not yet implemented)
```

---

## L. Recommendations for Next Steps

### Critical (BLOCKERS - Must Fix Before Build)
1. **Move `public/index.html` → `index.html`**
2. **Edit `index.html` line 129:** Change `../src/main.js` to `/src/main.js`
3. **Edit `vite.config.js`:** Remove `root: 'public'`, change `outDir: '../dist'` to `'dist'`, remove `fs.allow`
4. **Verify build:** Run `npm run build` (should succeed)

### High Priority (Performance/UX)
5. **Cache tracts GeoJSON:** Run `scripts/fetch_tracts.mjs` → save to `public/data/tracts_phl.geojson`
6. **Precompute tract counts:** Run `scripts/precompute_tract_counts.mjs` → save to `src/data/tract_counts_last12m.json`

### Medium Priority (Code Health)
7. **Audit orphan modules:** Check if `src/config.js`, `src/utils/pop_buffer.js`, `src/map/wire_points.js` are actually imported
8. **Add >20k feature guard:** If not present, add guard in `src/map/points.js` or caller to prevent rendering too many unclustered points

---

**Audit completed:** 2025-10-15 16:04
**Status:** Structure violations found (3 blockers). Data artifacts mostly valid. Subsystems mapped.
**Next:** Create docs/STRUCTURE_AUDIT.md, FILE_MAP.md, EDIT_POINTS.md from this analysis.
