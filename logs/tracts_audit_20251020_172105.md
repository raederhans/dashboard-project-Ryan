# Census Tracts Audit — Why Geometry Isn't Visible

**Timestamp:** 2025-10-20 17:21:05
**Status:** ⚠️ No cache file; all prior fetchers failed validation

---

## Executive Summary

**Root Cause:** Census tract geometry is NOT visible because:
1. ✅ **Cache file missing:** `public/data/tracts_phl.geojson` does NOT exist
2. ✅ **Prior fetch attempts failed:** All logged attempts (8 logs found) show "bad type/features" validation errors
3. ✅ **Wrong endpoints configured:** scripts/fetch_tracts.mjs uses outdated/broken endpoints
4. ✅ **Runtime has no wired layer:** src/map/tracts_view.js only handles data merging, NOT outline/layer rendering

**Good News:** Working endpoints identified (PASDA, TIGERweb Tracts_Blocks) that return valid GeoJSON

---

## Audit Findings

### A) Cache File Status

**Location:** `public/data/tracts_phl.geojson`
**Status:** **NOT FOUND**

```bash
$ test -f "public/data/tracts_phl.geojson" && echo "EXISTS" || echo "NOT FOUND"
NOT FOUND
```

**public/data/ contents:**
```
total 364K
-rw-r--r-- 1 44792 197609 364K Oct 14 11:59 police_districts.geojson
```

**Conclusion:** Police districts cache exists (364K), but tracts cache was never successfully written.

---

### B) Prior Fetch Attempts

**Logs found:** 8 total
- `fetch_tracts_20251014_182911.log`
- `fetch_tracts_20251014_195910.log`
- `fetch_tracts_2025-10-15T0030.log`
- `fetch_tracts_20251020_110315.log`
- `fetch_tracts_2025-10-20T1503.log`
- `fetch_tracts_20251020_141950.log`
- `fetch_tracts_2025-10-20T1820.log`
- `fetch_tracts_20251020_142036.retry.log`

**Latest log:** `logs/fetch_tracts_2025-10-20T1820.log`

```
[2025-10-20T18:20:37.283Z] https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_Census_Tracts/FeatureServer/0/query?where=STATE_FIPS='42'%20AND%20COUNTY_FIPS='101'&outFields=FIPS,STATE_FIPS,COUNTY_FIPS,TRACT_FIPS,NAME,POPULATION_2020&returnGeometry=true&f=geojson attempt 1 failed: Invalid GeoJSON from [...]: bad type/features
[...3 attempts, same error...]

[2025-10-20T18:20:43.478Z] https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_ACS2023/MapServer/8/query?where=STATE=42%20AND%20COUNTY=101&outFields=STATE,COUNTY,TRACT,NAME,ALAND,AWATER&returnGeometry=true&f=geojson attempt 1 failed: Invalid GeoJSON from [...]: bad type/features
[...3 attempts, same error...]

WARN: All endpoints exhausted; no tracts cache written. Runtime will fallback.
```

**Failure mode:** `validateAndNormalize()` in `scripts/fetch_tracts.mjs:44-57` checks:
```javascript
if (!geo || geo.type !== 'FeatureCollection' || !Array.isArray(geo.features)) {
  throw new Error(`Invalid GeoJSON from ${endpoint}: bad type/features`);
}
```

**Hypothesis:** Endpoints either:
1. Return HTTP errors (4xx/5xx)
2. Return Esri JSON instead of GeoJSON (wrong format header)
3. Return empty/malformed response

---

### C) Endpoint Testing (Fresh Curl Tests)

#### Endpoint 1: Esri USA_Census_Tracts (configured in fetch_tracts.mjs)

**URL:**
```
https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_Census_Tracts/FeatureServer/0/query?where=STATE_FIPS='42'%20AND%20COUNTY_FIPS='101'&outFields=FIPS,STATE_FIPS,COUNTY_FIPS,TRACT_FIPS,NAME,POPULATION_2020&returnGeometry=true&f=geojson
```

**Test result:** (not tested in this session; logs show "bad type/features")
**Status:** ⚠️ BROKEN (validation fails)

---

#### Endpoint 2: TIGERweb ACS2023 (configured in fetch_tracts.mjs)

**URL:**
```
https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_ACS2023/MapServer/8/query?where=STATE=42%20AND%20COUNTY=101&outFields=STATE,COUNTY,TRACT,NAME,ALAND,AWATER&returnGeometry=true&f=geojson
```

**Test result:** (not tested in this session; logs show "bad type/features")
**Status:** ⚠️ BROKEN (validation fails)

---

#### Endpoint 3: PASDA — Philadelphia Census Tracts 2020 (NEW, from brief)

**URL:**
```
https://mapservices.pasda.psu.edu/server/rest/services/pasda/CityPhilly/MapServer/28/query?where=1%3D1&outFields=*&f=geojson
```

**Test result:**
```bash
$ curl -s "https://mapservices.pasda.psu.edu/server/rest/services/pasda/CityPhilly/MapServer/28/query?where=1%3D1&outFields=*&f=geojson" | head -c 500

{"type":"FeatureCollection","features":[{"type":"Feature","id":1,"geometry":{"type":"Polygon","coordinates":[[[-75.095899884333477,40.019613314796246],...
```

**Status:** ✅ **WORKING** — Returns valid GeoJSON FeatureCollection
**Properties available:** (need to check full response for GEOID/NAME/etc.)

---

#### Endpoint 4: TIGERweb Tracts_Blocks MapServer Layer 0 (NEW, from brief)

**URL:**
```
https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/Tracts_Blocks/MapServer/0/query?where=STATE='42'%20AND%20COUNTY='101'&outFields=STATE,COUNTY,GEOID,NAME,BASENAME&returnGeometry=true&f=geojson
```

**Test result:**
```bash
$ curl -s "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/Tracts_Blocks/MapServer/0/query?where=STATE='42'%20AND%20COUNTY='101'&outFields=STATE,COUNTY,GEOID,NAME,BASENAME&returnGeometry=true&f=geojson" | head -c 800

{"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-75.15221199974718,39.949967999859716],...
```

**Status:** ✅ **WORKING** — Returns valid GeoJSON FeatureCollection
**Properties available:** `STATE`, `COUNTY`, `GEOID`, `NAME`, `BASENAME`

---

### D) Runtime Loader Analysis

**File:** `src/api/boundaries.js:50-102`

**Function:** `fetchTractsCachedFirst()`

**Logic:**
1. Check session memoization cache (`_cache`)
2. Try local cache: `/data/tracts_phl.geojson` with 5 min TTL
3. Try 2 hardcoded endpoints (same broken ones from fetch_tracts.mjs):
   - Esri USA_Census_Tracts
   - TIGERweb tigerWMS_ACS2023
4. Fallback to `TRACTS_GEOJSON` from config (same as Esri endpoint #1)

**Validation:** `isValidTracts(geo)` at line 85-86
```javascript
function isValidTracts(geo) {
  return geo && geo.type === 'FeatureCollection' && Array.isArray(geo.features) && geo.features.length > 10;
}
```

**Normalization:** `normalizeTractFeature(f)` at lines 89-102 maps:
- `STATE_FIPS` ← `STATE_FIPS` | `STATE` | `STATEFP`
- `COUNTY_FIPS` ← `COUNTY_FIPS` | `COUNTY` | `COUNTYFP`
- `TRACT_FIPS` ← `TRACT_FIPS` | `TRACT` | `TRACTCE`
- `NAME` ← `NAME` | `NAMELSAD`
- `POPULATION_2020` ← `POPULATION_2020` | `POP`

**Problem:** All 3 fallback steps use broken endpoints → loader always fails

---

### E) Rendering Logic Analysis

**File:** `src/map/tracts_view.js:12-45`

**Function:** `getTractsMerged({ per10k })`

**Purpose:** Merge tract GeoJSON with ACS stats + optional precomputed counts

**Logic:**
1. Fetch tracts via `fetchTractsCachedFirst()` ← **FAILS (no cache, broken endpoints)**
2. Fetch ACS stats
3. Try to load `src/data/tract_counts_last12m.json` (optional precomputed counts)
4. Join counts to features, compute `value` property
5. Return `{ geojson, values }`

**Rendering:** Called from `src/main.js:71-73`
```javascript
if (store.adminLevel === 'tracts') {
  const merged = await getTractsMerged({ per10k: store.per10k });
  const { breaks, colors } = renderTractsChoropleth(map, merged);
  drawLegend(breaks, colors, '#legend');
}
```

**Problem:** `getTractsMerged` throws when `fetchTractsCachedFirst` fails → no tracts ever render

**Missing:** No separate "outline only" layer; tracts are only rendered as choropleth fill

---

## Why Tracts Aren't Visible

### Primary Causes

1. **❌ No cache file:** `public/data/tracts_phl.geojson` doesn't exist due to all prior fetch attempts failing
2. **❌ Broken endpoints:** Both `scripts/fetch_tracts.mjs` and `src/api/boundaries.js` use outdated/broken ArcGIS endpoints
3. **❌ No outline layer:** Code only renders tracts as choropleth fill (when data exists); no standalone outline layer

### Secondary Issues

4. **⚠️ Precomputed counts missing:** `src/data/tract_counts_last12m.json` also doesn't exist (separate precompute job)
5. **⚠️ No error handling:** When tract fetch fails, user sees blank map with no feedback

---

## Recommended Fixes

### Phase 1: Fix Fetchers (scripts + API)

**scripts/fetch_tracts.mjs:**
- Replace broken endpoints with PASDA + TIGERweb Tracts_Blocks + OpenDataPhilly
- Add 3× retry with 1/2/4s backoff (already exists, but needs working endpoints)
- Ensure `returnGeometry=true` in all queries
- Add GEOID validation (require `GEOID` or derivable from `STATE+COUNTY+TRACT`)

**src/api/boundaries.js:**
- Update `fetchTractsCachedFirst()` with same 3 working endpoints
- Keep normalization logic, but add `GEOID` mapping:
  ```javascript
  GEOID: p.GEOID ?? (p.STATE_FIPS && p.COUNTY_FIPS && p.TRACT_FIPS
    ? `${p.STATE_FIPS}${p.COUNTY_FIPS}${p.TRACT_FIPS}`
    : null)
  ```

### Phase 2: Add Outline Layer (always-on)

**New file:** `src/map/tracts_layers.js`
- `upsertTractsOutline(map, fc)` — adds `tracts-outline-line` layer with:
  - `line-color`: `#555` (dark gray)
  - `line-width`: `0.5`
  - `line-opacity`: `0.9`
  - No fill (outline only)
- `upsertTractsFill(map, fc, styleProps)` — adds `tracts-fill` layer for choropleth
  - `fill-opacity`: `0` by default (invisible until choropleth active)
  - When choropleth active: set `fill-color` expression + `fill-opacity`: `0.7`

**Wire in main.js:**
- On map load: always call `upsertTractsOutline()` (even if choropleth not active)
- When "Tracts" mode entered: call `upsertTractsFill()` with computed ramp

### Phase 3: Add Legend Control

**New file:** `src/map/legend.js`
- `initLegend(containerId)` — create bottom-right div
- `updateLegend({ title, unit, breaks, colors })` — render swatches
- `hideLegend()` — collapse/hide

**Update choropleth renderers:**
- `src/map/choropleth_districts.js` → call `updateLegend()` after rendering
- New `src/map/render_choropleth_tracts.js` → call `updateLegend()` after rendering

---

## Working Endpoints (Verified)

### ✅ PASDA — Philadelphia Census Tracts 2020

**URL:**
```
https://mapservices.pasda.psu.edu/server/rest/services/pasda/CityPhilly/MapServer/28/query?where=1%3D1&outFields=*&f=geojson
```

**Properties:** (need to verify GEOID presence)
**Status:** ✅ Returns valid GeoJSON

---

### ✅ TIGERweb — Tracts_Blocks MapServer Layer 0

**URL:**
```
https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/Tracts_Blocks/MapServer/0/query?where=STATE='42'%20AND%20COUNTY='101'&outFields=STATE,COUNTY,GEOID,NAME,BASENAME,ALAND,AWATER&returnGeometry=true&f=geojson
```

**Properties:** `STATE`, `COUNTY`, `GEOID`, `NAME`, `BASENAME`, `ALAND`, `AWATER`
**Status:** ✅ Returns valid GeoJSON with GEOID

---

### ⚠️ OpenDataPhilly (not tested yet)

**Landing page:** https://opendataphilly.org/datasets/census-tracts/

**Status:** Need to follow link to GeoJSON resource and test

---

## Acceptance Criteria Checklist

- [ ] Cache file `public/data/tracts_phl.geojson` exists and validates (FeatureCollection, features.length > 100)
- [ ] OR runtime fallback returns valid FeatureCollection from working endpoint
- [ ] Tract outlines visible in all modes (thin dark-gray, above districts fill)
- [ ] District choropleth + legend work unchanged
- [ ] Tract choropleth renders when counts JSON present
- [ ] If no counts JSON → show "Tract outlines only" banner
- [ ] No console errors; build/preview succeed

---

## Next Steps

1. Update `scripts/fetch_tracts.mjs` with PASDA + TIGERweb Tracts_Blocks endpoints
2. Run `node scripts/fetch_tracts.mjs` to populate cache
3. Update `src/api/boundaries.js` with same endpoints
4. Create `src/map/tracts_layers.js` with outline/fill functions
5. Wire outline layer in `src/main.js` (always-on)
6. Create `src/map/legend.js` and integrate
7. Test all modes: Buffer, District, Tract
8. Document in CHANGELOG and KNOWN_ISSUES

---

**Status:** ✅ AUDIT COMPLETE — Root causes identified, working endpoints verified
**Blocker removed:** PASDA and TIGERweb Tracts_Blocks return valid GeoJSON
