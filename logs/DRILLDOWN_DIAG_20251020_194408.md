# Drilldown Empty List ‚Äî Root Cause Diagnosis

**Timestamp**: 2025-10-20 19:44:08
**Issue**: Drilldown list always shows "No sub-codes in this window" even with valid offense groups and time window selected
**Severity**: P0 ‚Äî Feature completely broken

---

## Executive Summary

**ROOT CAUSE IDENTIFIED**: Critical typo in [src/api/crime.js:223](../src/api/crime.js#L223) ‚Äî `endIso` is set to `start` instead of `end`, creating a **zero-length time window** in the SQL query. This guarantees 0 rows returned, regardless of data availability.

---

## Code Flow Analysis

### 1. UI ‚Üí API Call Path

**File**: [src/ui/panel.js:77-112](../src/ui/panel.js#L77-L112)

When user selects offense groups:
```javascript
groupSel?.addEventListener('change', async () => {
  const values = Array.from(groupSel.selectedOptions).map((o) => o.value);
  store.selectedGroups = values;
  store.selectedDrilldownCodes = []; // Clear drilldown when parent groups change

  // populate drilldown options (filtered by time window availability)
  if (fineSel) {
    if (values.length === 0) {
      fineSel.innerHTML = '<option disabled>Select a group first</option>';
      fineSel.disabled = true;
    } else {
      fineSel.disabled = false;
      fineSel.innerHTML = '<option disabled>Loading...</option>';

      try {
        const { start, end } = store.getStartEnd(); // ‚Üê Gets time window
        const availableCodes = await fetchAvailableCodesForGroups({ start, end, groups: values }); // ‚Üê API call

        fineSel.innerHTML = '';
        if (availableCodes.length === 0) {
          fineSel.innerHTML = '<option disabled>No sub-codes in this window</option>'; // ‚Üê Shown when empty
        } else {
          for (const c of availableCodes) {
            const opt = document.createElement('option');
            opt.value = c; opt.textContent = c; fineSel.appendChild(opt);
          }
        }
      } catch (err) {
        console.warn('Failed to fetch available codes:', err);
        fineSel.innerHTML = '<option disabled>Error loading codes</option>';
      }
    }
  }
  onChange();
});
```

**Confirmed**:
- ‚úÖ Function is called with correct parameters: `{ start, end, groups }`
- ‚úÖ No debounce suppression (async function executes immediately)
- ‚úÖ Error handling present (would show "Error loading codes" on network failure)
- ‚úÖ Empty result shows "No sub-codes in this window" (line 98)

---

### 2. API Function ‚Äî THE BUG

**File**: [src/api/crime.js:210-246](../src/api/crime.js#L210-L246)

```javascript
export async function fetchAvailableCodesForGroups({ start, end, groups }) {
  if (!Array.isArray(groups) || groups.length === 0) {
    return [];
  }

  // Expand group keys to offense codes
  const expandedCodes = expandGroupsToCodes(groups);
  if (expandedCodes.length === 0) {
    return [];
  }

  // Build SQL to get distinct codes with incidents in time window
  const startIso = Q.dateFloorGuard(start);
  const endIso = start; // ‚Üê üî¥ BUG! Should be: const endIso = end;
  const sanitized = Q.sanitizeTypes(expandedCodes);
  const codeList = sanitized.map((c) => `'${c}'`).join(', ');

  const sql = [
    'SELECT DISTINCT text_general_code',
    'FROM incidents_part1_part2',
    `WHERE dispatch_date_time >= '${startIso}'`,
    `  AND dispatch_date_time < '${endIso}'`,  // ‚Üê Uses startIso twice!
    `  AND text_general_code IN (${codeList})`,
    'ORDER BY text_general_code',
  ].join('\n');

  await logQuery('fetchAvailableCodesForGroups', sql);
  const json = await fetchJson(CARTO_SQL_BASE, {
    method: 'POST',
    headers: { 'content-type': 'application/x-www-form-urlencoded' },
    body: `q=${encodeURIComponent(sql)}`,
    cacheTTL: 60_000, // 60s cache
  });

  const rows = json?.rows || [];
  return rows.map((r) => r.text_general_code).filter(Boolean);
}
```

**üî¥ ROOT CAUSE**: Line 223 sets `endIso = start` instead of `endIso = end`.

---

## SQL Evidence

### Expected Query (if bug were fixed)

Assume user selects:
- **Offense Group**: "Vehicle" ‚Üí Expands to: `['Motor Vehicle Theft', 'Theft from Vehicle']`
- **Time Window**: 2024-01-01 to 2025-01-01

Expected SQL:
```sql
SELECT DISTINCT text_general_code
FROM incidents_part1_part2
WHERE dispatch_date_time >= '2024-01-01'
  AND dispatch_date_time < '2025-01-01'
  AND text_general_code IN ('Motor Vehicle Theft', 'Theft from Vehicle')
ORDER BY text_general_code
```

**Expected Result**: 2 rows (both codes present in 2024 data)

---

### Actual Query (current bug)

Actual SQL generated (with bug):
```sql
SELECT DISTINCT text_general_code
FROM incidents_part1_part2
WHERE dispatch_date_time >= '2024-01-01'
  AND dispatch_date_time < '2024-01-01'  -- ‚Üê Zero-length window!
  AND text_general_code IN ('Motor Vehicle Theft', 'Theft from Vehicle')
ORDER BY text_general_code
```

**Actual Result**: 0 rows (impossible to have incidents on '2024-01-01' that are also before '2024-01-01')

---

### Test URL (current bug)

**CARTO SQL Base**: https://phl.carto.com/api/v2/sql

**Example Request** (Vehicle group, 2024-01-01 to 2025-01-01):
```
POST https://phl.carto.com/api/v2/sql
Content-Type: application/x-www-form-urlencoded

q=SELECT%20DISTINCT%20text_general_code%0AFROM%20incidents_part1_part2%0AWHERE%20dispatch_date_time%20%3E%3D%20%272024-01-01%27%0A%20%20AND%20dispatch_date_time%20%3C%20%272024-01-01%27%0A%20%20AND%20text_general_code%20IN%20%28%27Motor%20Vehicle%20Theft%27%2C%20%27Theft%20from%20Vehicle%27%29%0AORDER%20BY%20text_general_code
```

**Decoded query**:
```sql
SELECT DISTINCT text_general_code
FROM incidents_part1_part2
WHERE dispatch_date_time >= '2024-01-01'
  AND dispatch_date_time < '2024-01-01'
  AND text_general_code IN ('Motor Vehicle Theft', 'Theft from Vehicle')
ORDER BY text_general_code
```

**Expected Response**:
```json
{
  "rows": [],
  "time": 0.002,
  "fields": {...},
  "total_rows": 0
}
```

---

## Field Verification

**Table Field**: `text_general_code` (confirmed in SQL builders across codebase)

**Sample Values** from [src/data/offense_groups.json](../src/data/offense_groups.json):
```json
{
  "Vehicle": [
    "Motor Vehicle Theft",
    "Theft from Vehicle"
  ],
  "Property": [
    "Thefts"
  ],
  "Burglary": [
    "Burglary Non-Residential",
    "Burglary Residential"
  ]
}
```

**Case/Whitespace**: Exact match required. Code uses `Q.sanitizeTypes()` which escapes single quotes but preserves case/whitespace, so values match CARTO table exactly.

---

## Suppression Guards Checked

### 1. Empty Groups Guard ‚úÖ WORKS
**File**: [panel.js:84-87](../src/ui/panel.js#L84-L87)
```javascript
if (values.length === 0) {
  fineSel.innerHTML = '<option disabled>Select a group first</option>';
  fineSel.disabled = true;
}
```
**Status**: Correctly prevents API call when no groups selected.

---

### 2. Empty Expanded Codes Guard ‚úÖ WORKS
**File**: [crime.js:216-219](../src/api/crime.js#L216-L219)
```javascript
const expandedCodes = expandGroupsToCodes(groups);
if (expandedCodes.length === 0) {
  return [];
}
```
**Status**: Correctly returns empty array if group expansion fails (e.g., invalid group key).

---

### 3. Network Error Guard ‚úÖ WORKS
**File**: [panel.js:105-108](../src/ui/panel.js#L105-L108)
```javascript
catch (err) {
  console.warn('Failed to fetch available codes:', err);
  fineSel.innerHTML = '<option disabled>Error loading codes</option>';
}
```
**Status**: Network errors show "Error loading codes" (distinct from "No sub-codes").

---

### 4. Cache Behavior ‚ö†Ô∏è POTENTIAL ISSUE

**File**: [src/utils/http.js:70-124](../src/utils/http.js#L70-L124)

Cache key includes: `method + url + hash(body)`
Cache TTL: 60 seconds (line 241 in crime.js)

**Potential issue**: If initial buggy query returns `[]` (0 rows), this empty result is cached for 60s. Even if bug is fixed mid-session, cached empty result persists until TTL expires or page reload.

**Workaround**: Clear sessionStorage or wait 60s after fix deployment.

---

## Reset Rules Verified ‚úÖ

**File**: [panel.js:80](../src/ui/panel.js#L80)
```javascript
store.selectedDrilldownCodes = []; // Clear drilldown when parent groups change
```

**Status**: Correctly clears drilldown selections when parent groups change, triggering fresh API call.

---

## Root Cause Statement

**Primary Cause**: Typo in `fetchAvailableCodesForGroups()` at [crime.js:223](../src/api/crime.js#L223) ‚Äî `endIso` assigned to `start` instead of `end`, creating zero-length time window in SQL query.

**Impact**: Query **always** returns 0 rows, regardless of:
- Time window selected (6mo, 12mo, 24mo)
- Offense groups selected (all groups affected equally)
- Data availability (even when thousands of incidents exist)

**Secondary Factor**: HTTP cache (60s TTL) persists empty results, masking quick fix attempts without page reload.

---

## Additional Observations

### Time Window Calculation

**File**: [src/state/store.js:46-54](../src/state/store.js#L46-L54)
```javascript
getStartEnd() {
  if (this.startMonth && this.durationMonths) {
    const startD = dayjs(`${this.startMonth}-01`).startOf('month');
    const endD = startD.add(this.durationMonths, 'month').endOf('month');
    return { start: startD.format('YYYY-MM-DD'), end: endD.format('YYYY-MM-DD') };
  }
  const end = dayjs().format('YYYY-MM-DD');
  const start = dayjs().subtract(this.timeWindowMonths || 6, 'month').format('YYYY-MM-DD');
  return { start, end };
}
```

**Status**: ‚úÖ Time window calculation is correct. Returns proper `start` and `end` values (e.g., `2024-01-01` to `2025-01-01`).

---

### Group Expansion Logic

**File**: [src/utils/types.js:51-60](../src/utils/types.js#L51-L60)

```javascript
export function expandGroupsToCodes(selectedGroups = []) {
  const out = [];
  for (const key of selectedGroups) {
    const k = key.replace(/[- ]/g, '_');
    const arr = offenseGroups[key] || offenseGroups[k] || offenseGroups[key?.toUpperCase?.()] || offenseGroups[key?.toLowerCase?.()];
    if (Array.isArray(arr)) out.push(...arr);
  }
  // de-duplicate
  return Array.from(new Set(out));
}
```

**Status**: ‚úÖ Group expansion works correctly. Handles case variations, de-duplicates, returns proper code arrays.

**Example**: `expandGroupsToCodes(['Vehicle'])` ‚Üí `['Motor Vehicle Theft', 'Theft from Vehicle']`

---

## Files Involved

| File | Role | Status |
|------|------|--------|
| [src/ui/panel.js](../src/ui/panel.js) | Triggers API call on group change | ‚úÖ Working |
| [src/api/crime.js](../src/api/crime.js) | Builds SQL query | üî¥ **BUGGY** (line 223) |
| [src/utils/sql.js](../src/utils/sql.js) | SQL sanitization helpers | ‚úÖ Working |
| [src/utils/types.js](../src/utils/types.js) | Group‚Üícodes expansion | ‚úÖ Working |
| [src/utils/http.js](../src/utils/http.js) | HTTP caching layer | ‚ö†Ô∏è Caches empty results |
| [src/state/store.js](../src/state/store.js) | Time window calculation | ‚úÖ Working |
| [src/data/offense_groups.json](../src/data/offense_groups.json) | Group definitions | ‚úÖ Valid |

---

## Next Steps

See **[docs/DRILLDOWN_FIX_PLAN.md](../docs/DRILLDOWN_FIX_PLAN.md)** for codex-ready patch plan with acceptance tests.

**Immediate Fix**: Change 1 character in crime.js:223:
```diff
- const endIso = start; // Use raw value for end (ensured in sanitizeTypes)
+ const endIso = end;
```

**Expected Result**: Drilldown list populates with 1-6 codes per group (varies by time window and data availability).
