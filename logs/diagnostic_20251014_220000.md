# Dashboard Diagnostic Report
**Date:** 2025-10-14T22:00:00Z
**Time Limit:** 5 minutes
**Status:** COMPLETED

---

## A) FINDINGS

### 1) PROJECT WIRING SANITY ‚úì

**Directory Structure:**
- `index.html` located at: `public/index.html` (correct for Vite)
- Root structure: src/, public/, node_modules/, package.json

**HTML Analysis (public/index.html):**
- Line 27: `<div id="map"></div>` ‚úì PRESENT
- Line 87: `<script type="module" src="/src/main.js"></script>` ‚úì PRESENT
- Canvas elements for charts: chart-monthly, chart-topn, chart-7x24 ‚úì PRESENT

**JavaScript Wiring (src/main.js):**
- Line 20: `initMap()` call ‚úì PRESENT
- Lines 30-36: Choropleth initialization in map.on('load') ‚úì PRESENT
- Lines 45-50: Chart initialization with updateAllCharts() ‚úì PRESENT
- Lines 16: Future hook placeholder (non-blocking comment)

**Map Initialization (src/map/initMap.js):**
- Lines 8-28: MapLibre initialization with OSM basemap ‚úì CORRECT
- Center: [-75.1652, 39.9526] (Philadelphia) ‚úì
- Zoom: 11 ‚úì

**Choropleth Pipeline:**
- src/map/choropleth_districts.js: Calls fetchPoliceDistrictsCachedFirst() and fetchByDistrict() ‚úì
- src/map/render_choropleth.js: Adds districts source and layers to map ‚úì

**Charts Pipeline (src/charts/index.js):**
- Line 46: Gets canvas context for 'chart-monthly' ‚úì
- Line 50: Gets canvas context for 'chart-topn' ‚úì
- Line 54: Gets canvas context for 'chart-7x24' ‚úì
- Calls renderMonthly(), renderTopN(), render7x24() ‚úì

**‚ö†Ô∏è CRITICAL ISSUE:**
- ALL THREE chart modules (line_monthly.js, bar_topn.js, heat_7x24.js) import `Chart from 'chart.js/auto'`
- This FAILS because chart.js is NOT INSTALLED

---

### 2) CACHED DATA PRESENCE ‚úì

**police_districts.geojson:**
- Path: `public/data/police_districts.geojson`
- Size: 364KB ‚úì
- Features: 21 districts ‚úì
- Has `DIST_NUMC` property: YES ‚úì
- Sample: {"DIST_NUMC": "24", "OBJECTID": 1, ...} ‚úì

**No fetch_districts logs found** (not needed - cache exists)

---

### 3) SQL BUILDERS SANITY ‚úì

**SQL Generation Test (src/utils/sql.js):**

```
Points Query (¬ß2.1):
  ‚úì Includes: WHERE dispatch_date_time >= '2015-01-01'
  ‚úì Includes: AND dispatch_date_time >= '2024-04-01'
  ‚úì Includes: AND dispatch_date_time < '2024-10-01'
  ‚úì Includes: AND the_geom && ST_MakeEnvelope(..., 3857)
  ‚úì SELECT the_geom, dispatch_date_time, text_general_code, ucr_general, dc_dist, location_block

ByDistrict Query (¬ß2.6):
  ‚úì Includes: WHERE dispatch_date_time >= '2015-01-01'
  ‚úì Includes: temporal filters
  ‚úì GROUP BY dc_dist
  ‚úì Proper SQL structure

CARTO URLs:
  ‚úì Base: https://phl.carto.com/api/v2/sql
  ‚úì format=GeoJSON parameter for points
  ‚úì Properly URL-encoded queries
```

**API Layer (src/api/crime.js):**
- All functions (fetchPoints, fetchByDistrict, fetchMonthlySeriesCity, etc.) ‚úì
- Proper SQL builder calls ‚úì
- URL construction with CARTO_SQL_BASE ‚úì

---

### 4) RUNTIME SMOKE TEST ‚ö†Ô∏è

**Vite Server:**
- Started: YES ‚úì
- Port: 5174 (5173 was in use)
- Status: Ready in 330ms ‚úì
- Local URL: http://localhost:5174/
- Network URL: http://10.192.1.183:5174/

**‚ùå FATAL ERROR:**
```
Error: The following dependencies are imported but could not be resolved:
  chart.js/auto (imported by .../src/charts/line_monthly.js)
Are they installed?
```

**Log:** `logs/diag_vite_20251014_215619.log`

**npm list verification:**
```
‚îú‚îÄ‚îÄ @turf/turf@6.5.0 ‚úì
‚îú‚îÄ‚îÄ UNMET DEPENDENCY chart.js@^4.4.0 ‚ùå
‚îú‚îÄ‚îÄ dayjs@1.11.18 ‚úì
‚îú‚îÄ‚îÄ luxon@3.7.2 ‚úì
‚îú‚îÄ‚îÄ maplibre-gl@4.7.1 ‚úì
‚îî‚îÄ‚îÄ vite@5.4.20 ‚úì

npm error missing: chart.js@^4.4.0, required by dashboard-project@0.0.0
```

**Server killed:** YES (as required)

---

### 5) BROWSERLESS RUNTIME GUARDRAILS ‚úì

**Error Handling in src/main.js:**
- Lines 37-39: `catch (err) { console.warn('Choropleth demo failed:', err); }` ‚úì
- Lines 48-50: `catch (err) { console.warn('Charts failed to render:', err); }` ‚úì
- Lines 67, 69, 72, 81: `.catch()` with console.warn for async operations ‚úì

**Assessment:** Error handling is PRESENT but uses `console.warn()` which:
- ‚úì Prevents app crash
- ‚ö†Ô∏è Silently fails chart rendering (user sees blank charts)
- ‚ö†Ô∏è User has no visual feedback about missing dependency

**Placeholders Found (non-blocking):**
- src/main.js:16 - Future hook (comment only)
- src/charts/index.js:1 - File header comment
- src/state/store.js:2 - JSDoc comment
- All are benign documentation strings

---

## B) LIKELY ROOT CAUSE(S)

### PRIMARY ROOT CAUSE: Missing chart.js Dependency ‚ùå

**Symptom:** UI shows, map renders, but NO charts display

**Evidence:**
1. `package.json` declares: `"chart.js": "^4.4.0"`
2. `npm list` shows: `UNMET DEPENDENCY chart.js@^4.4.0`
3. Three chart modules import: `import { Chart } from 'chart.js/auto';`
4. Vite fails with: "chart.js/auto could not be resolved"
5. Browser console would show: Chart is not defined (or similar)

**Why Charts Don't Render:**
- main.js line 46-47 calls `updateAllCharts()` in try/catch
- charts/index.js line 46 calls `renderMonthly(ctx, ...)`
- line_monthly.js line 29 tries to instantiate `new Chart(ctx, ...)` ‚Üê FAILS
- Error is caught by main.js line 48-50: `console.warn('Charts failed to render:', err)`
- Canvas elements remain empty (blank white rectangles)

**Why Map DOES Render:**
- Map initialization (lines 20-36) does NOT depend on chart.js
- MapLibre GL and districts choropleth work independently
- Map layers successfully added (districts-fill, districts-line)

**Impact:**
- Map: ‚úì Works
- Choropleth: ‚úì Works (if CARTO API responds)
- Charts: ‚ùå All three fail silently
- User sees: Blank chart canvases with no data

---

### SECONDARY ISSUES (Minor):

**None found.** All other wiring is correct.

---

## C) PROPOSED MINIMAL FIXES

### FIX 1: Install Missing Dependency (IMMEDIATE) üî¥

**Action:**
```bash
npm install chart.js@^4.4.0
```

**Validation:**
```bash
npm list chart.js
# Should show: chart.js@4.x.x (not "UNMET DEPENDENCY")
```

**Expected Result:**
- chart.js installed to node_modules/
- Vite dev server starts without errors
- Charts render with data

**Time to fix:** < 30 seconds

---

### FIX 2: Verify Chart Rendering (AFTER FIX 1)

**Action:**
```bash
npm run dev
# Open browser to http://localhost:5173/
# Check browser console for errors
# Verify three charts display data
```

**Expected Console Output:**
- No "chart.js/auto could not be resolved" errors
- No "Chart is not defined" errors
- Possible warnings: "Charts failed to render" IF CARTO API call fails (separate issue)

**If charts still don't render after FIX 1:**
- Check browser console for CARTO API errors (CORS, 429 rate limit, etc.)
- Verify network tab shows successful SQL API responses
- Check that store.getFilters() returns valid center3857 and radiusM

---

### FIX 3: Optional UX Improvement (LOW PRIORITY)

**Problem:** Silent failures hide errors from user

**Action:** Add visual error indicators in HTML:
```javascript
// In src/charts/index.js, wrap updateAllCharts with:
export async function updateAllCharts(params) {
  try {
    // ... existing code ...
  } catch (err) {
    console.error('Charts update failed:', err);
    // Show error overlay on chart containers
    document.querySelectorAll('#charts canvas').forEach(canvas => {
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fee';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#c00';
      ctx.font = '14px sans-serif';
      ctx.fillText('Chart failed to load', 10, canvas.height/2);
    });
  }
}
```

**Benefit:** User sees "Chart failed to load" instead of blank canvas

---

## SUMMARY

### DIAG SUMMARY:

**Wiring:** ‚úì OK - index.html in public/, script tag present, initMap() called, all init paths exist

**Cache:** ‚úì OK - police_districts.geojson present (364KB, 21 features, has DIST_NUMC)

**SQL:** ‚úì OK - Builders generate correct queries with dispatch_date_time >= '2015-01-01' and proper WHERE clauses

**Vite:** ‚ö†Ô∏è SERVER STARTS (port 5174) but FAILS on chart.js/auto import - index.html served from public/

**Actions to take NOW:**
1. Run `npm install chart.js@^4.4.0` to install missing dependency
2. Restart dev server: `npm run dev`
3. Open browser and verify charts render (check console for CARTO API errors if still blank)

---

**Diagnosis complete. Total time: ~4 minutes.**
