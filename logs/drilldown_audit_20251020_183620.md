# Drilldown Pipeline Audit — Child Offense Codes

**Timestamp**: 2025-10-20 18:36:20
**Task**: Audit drilldown (child offense codes) pipeline to diagnose why list is empty and implement end-to-end support

---

## 1. Data Structure: offense_groups.json ✅

**Location**: [src/data/offense_groups.json](../src/data/offense_groups.json)

**Shape**: `{ GroupName: [ "Code1", "Code2", ... ] }`

**Example**:
```json
{
  "Vehicle": [
    "Motor Vehicle Theft",
    "Theft from Vehicle"
  ],
  "Property": [
    "Thefts"
  ],
  "Burglary": [
    "Burglary Non-Residential",
    "Burglary Residential"
  ]
}
```

**Status**: ✅ EXISTS — Structure is correct with 6 groups and ~10 unique codes

---

## 2. UI Panel: Drilldown Population — PARTIAL ⚠️

**Location**: [src/ui/panel.js](../src/ui/panel.js)

### Current Implementation (Lines 74-93)

**Group Selection Handler** (lines 74-87):
```javascript
groupSel?.addEventListener('change', () => {
  const values = Array.from(groupSel.selectedOptions).map((o) => o.value);
  store.selectedGroups = values;
  // populate drilldown options
  if (fineSel) {
    const codes = getCodesForGroups(values); // ← Expands all codes for selected groups
    fineSel.innerHTML = '';
    for (const c of codes) {
      const opt = document.createElement('option');
      opt.value = c; opt.textContent = c; fineSel.appendChild(opt);
    }
  }
  onChange();
});
```

**Drilldown Selection Handler** (lines 89-93):
```javascript
fineSel?.addEventListener('change', () => {
  const codes = Array.from(fineSel.selectedOptions).map((o) => o.value);
  store.selectedTypes = codes; // ← Overwrites selectedTypes directly
  onChange();
});
```

### Issues Identified

1. **No Time-Window Filtering**: `getCodesForGroups()` returns ALL codes for selected groups, regardless of whether they have incidents in the current time window
2. **Direct State Overwrite**: Drilldown selection overwrites `store.selectedTypes` directly instead of using a separate `selectedDrilldownCodes` state
3. **No Empty State Handling**: No UI hints when parent groups are empty or when no codes exist in the time window
4. **No Override Indicator**: No visual feedback that drilldown overrides parent group selection

**Status**: ⚠️ PARTIAL — Populates list but not filtered by time window availability

---

## 3. State Management: selectedDrilldownCodes — MISSING ❌

**Location**: [src/state/store.js](../src/state/store.js)

### Current State Shape (lines 24-78)
```javascript
export const store = {
  selectedGroups: [],     // Parent offense groups
  selectedTypes: [],      // Directly set offense codes
  // ... other state
  getFilters() {
    const { start, end } = this.getStartEnd();
    const types = (this.selectedTypes && this.selectedTypes.length)
      ? this.selectedTypes.slice()
      : expandGroupsToCodes(this.selectedGroups || []);
    return { start, end, types, center3857, radiusM, queryMode, ... };
  }
};
```

### Issues Identified

1. **No `selectedDrilldownCodes` key**: State doesn't differentiate between direct type selection and drilldown override
2. **getFilters() doesn't support drilldown**: Returns `types` based on `selectedTypes` or expanded groups, no drilldown-specific logic

**Status**: ❌ MISSING — No separate drilldown state

---

## 4. SQL Builders: Drilldown Override — MISSING ❌

**Location**: [src/utils/sql.js](../src/utils/sql.js)

### Current Implementation (lines 353-372)

**baseTemporalClauses()** used by all SQL builders:
```javascript
function baseTemporalClauses(startIso, endIso, types, { includeTypes = true } = {}) {
  const clauses = [
    "WHERE dispatch_date_time >= '2015-01-01'",
    `  AND dispatch_date_time >= '${startIso}'`,
    `  AND dispatch_date_time < '${endIso}'`,
  ];

  if (includeTypes) {
    const sanitizedTypes = sanitizeTypes(types); // ← Uses 'types' directly
    if (sanitizedTypes.length > 0) {
      clauses.push(
        `  AND text_general_code IN (${sanitizedTypes
          .map((value) => `'${value}'`)
          .join(", ")})`
      );
    }
  }
  return clauses;
}
```

### Issues Identified

1. **No Drilldown Parameter**: Builders accept `types` but not `drilldownCodes`
2. **No Override Logic**: No conditional to check if drilldown should take precedence over parent group expansion

**Status**: ❌ MISSING — No drilldown override support

---

## 5. API: fetchAvailableCodesForGroups — MISSING ❌

**Location**: [src/api/crime.js](../src/api/crime.js)

### Current State
- No function exists to fetch available codes for selected groups within time window
- Existing functions: `fetchPoints`, `fetchMonthlySeriesCity`, `fetchByDistrict`, etc.

### Required Implementation

```javascript
/**
 * Fetch available offense codes for selected groups within time window.
 * Filters to only codes that have at least 1 incident in [start, end).
 * @param {{start:string,end:string,groups:string[]}} params
 * @returns {Promise<string[]>} Alphabetized array of available codes
 */
export async function fetchAvailableCodesForGroups({ start, end, groups }) {
  // 1. Expand groups → codes via expandGroupsToCodes()
  // 2. Query CARTO:
  //    SELECT DISTINCT text_general_code
  //    FROM incidents_part1_part2
  //    WHERE dispatch_date_time >= :start
  //      AND dispatch_date_time < :end
  //      AND text_general_code IN (:expandedCodes)
  //    ORDER BY text_general_code
  // 3. Return alphabetized array
}
```

**Status**: ❌ MISSING — Function doesn't exist

---

## 6. Type Expansion Utility — EXISTS ✅

**Location**: [src/utils/types.js](../src/utils/types.js)

**Functions**:
- `expandGroupsToCodes(selectedGroups)` (lines 51-60): Expands group keys to codes ✅
- `getCodesForGroups(groups)` (line 62): Alias for `expandGroupsToCodes` ✅

**Status**: ✅ EXISTS — Utility functions work correctly

---

## Summary of Findings

| Component | Status | Issue |
|-----------|--------|-------|
| **offense_groups.json** | ✅ EXISTS | Data structure correct |
| **panel.js population** | ⚠️ PARTIAL | Populates list but no time-window filtering |
| **panel.js selection** | ⚠️ PARTIAL | Overwrites `selectedTypes` directly |
| **State: selectedDrilldownCodes** | ❌ MISSING | No separate drilldown state key |
| **State: getFilters()** | ❌ MISSING | No drilldown support in filter output |
| **SQL: drilldown override** | ❌ MISSING | No logic to use drilldown codes over parent groups |
| **API: fetchAvailableCodesForGroups** | ❌ MISSING | Function doesn't exist |
| **Type expansion utility** | ✅ EXISTS | Works correctly |

---

## Root Cause

**Why Drilldown List is Empty**:
1. UI populates drilldown when groups change (lines 74-87 of panel.js)
2. **BUT**: No initial population on page load (groups default to `[]`)
3. **AND**: Even when populated, shows ALL codes for groups (not filtered by time window)

**Why Drilldown Doesn't Filter Data**:
1. Drilldown selection overwrites `store.selectedTypes` (line 91 of panel.js)
2. State has no separate `selectedDrilldownCodes` key
3. SQL builders don't check for drilldown override
4. Result: Drilldown selection works same as selecting parent groups (no distinction)

---

## Implementation Plan

See detailed implementation patches in [FIX_PLAN_DRILLDOWN.md](../docs/FIX_PLAN_DRILLDOWN.md) (to be created next).

**High-level steps**:
1. Add `fetchAvailableCodesForGroups()` to crime.js
2. Add `selectedDrilldownCodes: []` to store.js state
3. Update `store.getFilters()` to return drilldownCodes
4. Update SQL builders to check drilldownCodes before parent groups
5. Update panel.js to call API and populate only available codes
6. Add UX hints for empty states and override indicators

---

## Files to Modify

1. [src/api/crime.js](../src/api/crime.js) — Add fetchAvailableCodesForGroups
2. [src/state/store.js](../src/state/store.js) — Add selectedDrilldownCodes, update getFilters
3. [src/utils/sql.js](../src/utils/sql.js) — Add drilldown override logic
4. [src/ui/panel.js](../src/ui/panel.js) — Wire API call, update drilldown handlers, add hints
